name: ABLESTACK QEMU High-End Release Build

on:
  workflow_dispatch:
    inputs:
      qemu_version:
        description: 'QEMU Version (e.g., 9.2.4)'
        required: true
        default: '9.2.4'

permissions:
  contents: write # 릴리즈 생성을 위해 필수

jobs:
  build-rpm:
    strategy:
      matrix:
        rocky_version: ["9.6", "10.1"]
        qemu_version: ["${{ github.event.inputs.qemu_version }}"]
    
    runs-on: ubuntu-latest
    container:
      image: rockylinux/rockylinux:${{ matrix.rocky_version }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Enable Repositories and Install All Dependencies
        run: |
          # 1. 기본 플러그인 및 EPEL 활성화
          dnf install -y dnf-plugins-core epel-release
          
          # 2. Devel 및 CRB 리포지토리 활성화 (대표님 확인 사항 반영)
          dnf config-manager --set-enabled crb devel || true
          
          # 3. 메타데이터 갱신
          dnf makecache
          
          # 4. QEMU 빌드를 위한 모든 패키지 설치 (옵션 오프 방지)
          dnf install -y rpm-build rpmdevtools wget gcc make ninja-build git \
            python3-pip python3-tomli glib2-devel pixman-devel zlib-devel \
            libaio-devel liburing-devel libcap-ng-devel libattr-devel libseccomp-devel \
            libusb1-devel nettle-devel gnutls-devel cyrus-sasl-devel libcap-devel \
            libcurl-devel libxml2-devel systemd-devel \
            swtpm-devel swtpm-tools libcacard-devel mesa-libGL-devel \
            usbredir-devel libepoxy-devel libfdt-devel \
            libzstd-devel lzo-devel snappy-devel librbd-devel libblkio-devel \
            device-mapper-multipath-devel numactl-devel rdma-core-devel libpmem-devel
            
          # 5. Python 환경 추가 보강 (Rocky 9의 경우를 대비)
          pip3 install tomli

      - name: Prepare RPM Build Tree
        run: |
          rpmdev-setuptree
          # 매트릭스에 지정된 QEMU 버전을 다운로드
          wget https://download.qemu.org/qemu-${{ matrix.qemu_version }}.tar.xz -P ~/rpmbuild/SOURCES/

      - name: Execute RPM Build
        run: |
          MAJOR_VER=$(echo "${{ matrix.rocky_version }}" | cut -d. -f1)
          rpmbuild -ba \
            --define "_version ${{ matrix.qemu_version }}" \
            --define "_release 1.el${MAJOR_VER}" \
            SPECS/qemu-ablestack.spec

      - name: Upload to Release
        uses: softprops/action-gh-release@v2
        with:
          # 태그 이름: v9.2.4 (동일 태그일 경우 기존 릴리즈에 파일 추가)
          tag_name: v${{ matrix.qemu_version }}
          name: ABLESTACK QEMU Release v${{ matrix.qemu_version }}
          body: |
            ## ABLESTACK High-End QEMU Build
            - **QEMU Version:** ${{ matrix.qemu_version }}
            - **Target OS:** Rocky Linux ${{ matrix.rocky_version }}
            - **Features:** FT(COLO), RDMA, Ceph(RBD), ZSTD, NUMA, io_uring enabled.
          files: |
            /github/home/rpmbuild/RPMS/x86_64/*.rpm
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
